# JWTまとめ

## 1. JWTとは
JWT（JSON Web Token）は、  
**「この人は認証済み」という証明書を、電子的な署名でやりとりする仕組み**。  

- サーバーが「ユーザー認証に成功した」という証明を**JWTトークン**として発行  
- そのトークンをクライアントが持ち回り、APIにアクセスする時に提出  
- APIサーバー側は「トークンに押されたハンコ（署名）が正しいか」をチェックして利用者を認識  

ポイントは「セッションをサーバー側で保持しない」こと。  
トークンに情報と署名が含まれているので、ステートレスに認証できる。  

---

## 2. JWTトークンの中身
JWTは3つのパートでできている：

```
header.payload.signature
```

- **header** : アルゴリズム情報など（例: HS256, JWT）  
- **payload** : ユーザーID、有効期限など（誰でも読める）  
- **signature** : header と payload を秘密鍵で計算した結果（＝電子的なハンコ）  

署名の計算式（例: HMAC-SHA256）は公開されているが、  
**秘密鍵が漏れなければ署名は偽造できない**。  

---

## 3. すでにあるAPIにJWT認証を導入する具体例
「画面ソースから呼ばれるAPIに、JWT認証を入れたい」場合の流れ。

### 1. 全体像
- 認証用のAPI（例: `/login`）を作る  
- ユーザー認証成功時に、サーバーが秘密鍵で署名したJWTを発行  
- クライアントはそのJWTをCookieやLocalStorageに保存  
- 以降のAPIリクエストにはJWTを添付  
- サーバーはJWTを検証して処理を実行  

### 2. 認証フェーズ
```
Client → POST /login (ID/PW)
Server → JWT発行（署名済み）
```

### 3. リクエストフェーズ
```
Client → GET /api/resource (Authorization: Bearer {JWT})
Server → JWTを秘密鍵で検証 → OKなら処理
```

### 4. バックエンドでやること
- JWT発行処理（ログイン成功時）  
- JWT検証処理（API呼び出し時）  

### 5. フロントでやること
- JWTを安全に保存（CookieやLocalStorage）  
- API呼び出し時にJWTをヘッダに付与  

### 6. まとめフロー図
```
[ユーザー（画面）] 
ID/PWでログイン実行
↓
[APIサーバー]
ログイン処理と同時に、JWTの発番処理。
↓
[ユーザー（画面）]
ログイン成功情報、JWTを受け取り、JWTをcookieなどに保存（XSS対策でHttpOnlyをつけるのが一般的）。

[ユーザー（画面）] 
ログイン後の画面からなにかしらのAPI実行。
この時にヘッダにJWTを設定する。
↓
[APIサーバー] 
API処理の前にJWT認証をする。
受け取ったJWTの「header.payload.signature」の、headerとpayloadから新しくsignatureを再計算。
検証後の値が、受け取った「signature」の値と一致するか検証。
（ライブラリで用意されたメソッド簡単に検証できる）。
↓
[ユーザー（画面）] 
APIサーバーからAPIの処理結果が返却される。

```

---

## 4. ライブラリとかをインストールすることで実装を実現できるのか？
JWTそのものを一から実装するのは大変なので、各言語には便利なライブラリがある。  

例:  
- Node.js: `jsonwebtoken`  
- Python: `PyJWT`  
- Java: `jjwt`  

これらライブラリは「header+payload+秘密鍵 → 署名生成」と「署名検証」をやってくれる。  
開発者は **秘密鍵を設定するだけ** でOK。  

例（Node.js / jsonwebtoken）：
```javascript
const jwt = require('jsonwebtoken');
const secretKey = "秘密鍵の文字列"; // ←自分で決めて設定

const token = jwt.sign({ userId: 123 }, secretKey, { algorithm: 'HS256' });
```

---

## 5. JWT認証で必ずやること
必ず押さえておくべき2つ：
1. **発行（sign）**  
   - ユーザーが認証成功したときに秘密鍵でJWTを作る  
2. **検証（verify）**  
   - API呼び出し時にJWTが改ざんされていないかを秘密鍵で確認する  

その他は要件次第（例: 保存場所、リフレッシュトークン、失効処理）。  
でも「発行」と「検証」だけは必ず必要。  

---

## 6. 秘密鍵の管理（Key Vaultなど）
- **秘密鍵はJWTライブラリが勝手に作るものではない**  
  → 秘密鍵は開発者が自分で用意する  
- 秘密鍵はソースコードにベタ書きせず、**環境変数やKey Vaultで安全に管理**  
- Key Vaultを使えば：  
  - サーバー起動時に安全に鍵を取得できる  
  - アクセス権限を細かく制御可能  
  - ローテーションや監査ログもサポートされる  

---

## まとめ
JWT認証は、  
- **トークンに署名（秘密鍵を使った計算結果）を付ける仕組み**  
- **「発行」と「検証」さえ覚えれば本質はシンプル**  
- **秘密鍵は自分たちで用意し、安全に管理する（Key Vaultなど）**  
- これさえ押さえれば「すでにあるAPIへの導入」も難しくない  
